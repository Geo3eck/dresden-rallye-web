<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Dresden Rallye: Challenge your daily route</title>
    <link rel="shortcut icon" href="data/icons/fav.ico" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
    integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
    crossorigin=""></script>
  <link href="https://fonts.googleapis.com/css?family=Nanum+Gothic|Nunito|Roboto|Titillium+Web|Work+Sans&display=swap"
    rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4-src.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

  <link rel="stylesheet" href="style.css" />
</head>

<body>



  <div class="mapOverlayContainer">
    <div class="container">
      <div class="row"
        style="background-color:#eeeeee;            border-bottom: 2px solid #393e41; line-height: 1;padding:10px 5px 5px 5px;">
        <img src="data/icons/logo.png" class="logo" align="left" />
        <div class="infoText">
          Mit der DresDen Ralley kommst du aus deiner Komfortzone raus und bringst wieder frischen Wind in deinen
          Alltagstrott! Mit unseren Challenges bist du gefordert kreativ von A nach B zu kommen. Einfach das Formular
          ausfüllen und wir fordern dich heraus! Finde eine Route, die die Kriterien erfüllt und entdecke dabei
          vielleicht sogar neue Orte.
        </div>
      </div>
      <div class="row">
        <div class="dropDown">
          <div id="eingabeForm">
            <div>
              Startort
              <div class="form-group">
                <div class='input-group location'>
                  <input id='startauswahl' type='text' class="form-control" />
                </div>
              </div>
            </div>
            <div>
              Zielort
              <div class="form-group">
                <div class='input-group location'>
                  <input id='endauswahl' type='text' class="form-control" />
                </div>
              </div>
            </div>
            <div>
              <form>
                Schwierigkeitsgrad wählen:
                <fieldset>
                  <input type="radio" id="option1" name="Level" value="1">
                  <label for="leicht">Leicht</label>
                  <input type="radio" id="option2" name="Level" value="2">
                  <label for="normal">Normal</label>
                  <input type="radio" id="option3" name="Level" value="3">
                  <label for="exrem">Extrem</label>
                </fieldset>
                <br /> Wie viel Zeit hast du?
                <fieldset>
                  <input type="radio" id="option1" name="Zeit" value="1">
                  <label for="viel">Viel</label>
                  <input type="radio" id="option2" name="Zeit" value="2">
                  <label for="wenig">Wenig</label>
                  <input type="radio" id="option3" name="Zeit" value="3">
                  <label for="keine">Gar keine</label>
                </fieldset>
                <br />
                <input type="checkbox">
                <label class="custom-control-label" for="customSwitches">Hast du einen Schrittzähler?</label>
              </form>
            </div>
            <div>  </div>
            <div>
              früheste Abfahrtzeit
              <div class="form-group">
                <div class='input-group date' id='startdatumsauswahl'>
                  <input type='text' class="form-control" style="z-index: inherit 9;" />
                  <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                  </span>
                </div>
              </div>
            </div>
            <div>
              späteste Ankunftszeit
              <div class="form-group">
                <div class='input-group date' id='enddatumsauswahl'>
                  <input type='text' class="form-control" />
                  <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                  </span>
                </div>
              </div>
            </div>
            <div style="vertical-align:bottom;text-align: right;"><button class="btn">Challenge me!</button>
            </div>
              <div id="challenge"><small>Klicke auf den <b>"Challenge me!"-</b>Button, um deine heutige Aufgabe gemäß deinen Angaben zu bekommen.</small></div>
          </div>
        </div>
        <div class="selector">
          Challenge-App
        </div>
      </div>
      <div class="row">
        <div class='col-sm-12' id="KarteMitPunkt" />
      </div>
    </div>
    <script>

      // Karte mit Mittelpunkt Dresden erzeugen
      var laengenGrad = 13.74291803;
      var breitenGrad = 51.04991538;
      var kartenMittelpunktKoordinaten = [breitenGrad, laengenGrad];
      var zoomStufe = 13;
      var minDate = moment();
      var maxDate = moment();
      maxDate.add('1', 'hour');
      var karte = L.map('KarteMitPunkt').setView(kartenMittelpunktKoordinaten, zoomStufe);
      // Hintergrundkarte setzen
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; <a href="#" onclick="alert(\'Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community\')">Esri</a>'
      }).addTo(karte);

      var optionen = {
        filter: function (feature, layer) {
          return moment(feature.properties.coordTimes).isBetween(minDate, maxDate);
        }
      }

      var hoverZuMarkerAbstand = function (aktuelleZoomStufe) {
        return 0.39 / Math.pow(2, aktuelleZoomStufe - 6);
      };

      function availableStations() {
        $.post("https://webapi.vvo-online.de/tr/pointfinder", {
          "query": "Albert",
          "limit": 10,
          "stopOnly": false
        }, function (data) {
          if (data.Status.Code == 'Ok') {
            var points = data.Points;
            var names = points.map(point => point.split('|')[3])
            return names;
          } else {
            return "Fehler in der API";
          }
        });
      }

      function availableStations(input) {
        if (!input || input.length < 3) {
          return []
        }
        var inputData = {
          "query": input,
          "limit": 10,
          "stopOnly": false
        }
        return $.ajax({
          async: true,
          contentType: 'application/json',
          dataType: 'json',
          processData: false,
          type: 'POST',
          url: 'https://webapi.vvo-online.de/tr/pointfinder',
          data: JSON.stringify(inputData),
        });
      }

      var handleAvailableStationResult = (result, response) => {
        if (result.Status.Code == 'Ok') {
          var points = result.Points;
          var names = []
          for (index in points) {
            var point = points[index]
            names.push({
              id: point.split('|')[0],
              label: point.split('|')[3]
            })
          }
          response(names);
        } else {
          response(["Fehler in der API"]);
        }
      };

      $(function () {
        $('#startauswahl').autocomplete({
          source: (request, response) => {
            return availableStations(request).then(
              (result) => handleAvailableStationResult(result, response))
          },
          minLength: 2,
          delay: 100
        })
        $('#endauswahl').autocomplete({
          source: (request, response) => {
            return availableStations(request).then(
              (result) => handleAvailableStationResult(result, response))
          },
          minLength: 2,
          delay: 100
        })
        $('#startdatumsauswahl').datetimepicker({
          defaultDate: minDate,
        });
        $('#enddatumsauswahl').datetimepicker({
          defaultDate: maxDate,
          useCurrent: false
        });
        $("#startdatumsauswahl").on("dp.change", function (e) {
          minDate = moment(e.date)
          $('#enddatumsauswahl').data("DateTimePicker").minDate(e.date);
          schichtNeuLaden();
        });
        $("#enddatumsauswahl").on("dp.change", function (e) {
          maxDate = moment(e.date)
          $('#startdatumsauswahl').data("DateTimePicker").maxDate(e.date);
          schichtNeuLaden();
        });
      });

      var baseMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      });
      $.ajaxSetup({
        scriptCharset: "utf-8",
        contentType: "application/json; charset=utf-8"
      });
      var colors = ["#ff7f00", "#377eb8", "#4daf4a"]
      var names = ["route_car", "route_cycle", "route_walking"];
      var labels = ["Auto", "Fahrrad", "Zu Fuß"];
      var lineStrokeWeights = [8, 4, 2];

      var collectedFeatureLineItems = []

      var createGeoJsonLayer = function (data, colorName, weight) {
        var style = {
          weight: weight,
          color: colorName,
          fillOpacity: 0
        }
        return L.geoJson(data, {
          style: style,
          filter: function(feature) {
            feature.geometry.coordinates.forEach(item => collectedFeatureLineItems.push(item))
            return feature;
          }
        });
      };
      var layerLegendKey = function (name) {
        var color = colors[names.indexOf(name)];
        return "<img src='https://placehold.it/12/" + color.substr(1) + "/000000?text=+' style='display:inline'> " + labels[names.indexOf(name)]
      };



      var getChallenge = function(lineGeoJSON, pointCollectionGeoJSON) {
        var challengeIndex = none;
        var challengeDistance = Infinity;

          for (let i = 0; i < lineGeoJSON.features[0].geometry.coordinates.length; i++) {
            const fromCoordinate = lineGeoJSON.features[0].geometry.coordinates[i];
          for (let j = 0; j < pointCollectionGeoJSON.features.length; j++) {
            const toCoordinate = pointCollectionGeoJSON.features[j].geometry.coordinates;
            let distance = turf.distance(turf.point(fromCoordinate), turf.point(toCoordinate), {units: 'kilometers'})
          
            if (distance < challengeDistance) {
              challengeDistance = distance;
              challengeIndex = j;
            }
          }
        }
        return {challengeIndex: challengeIndex, challengeDistance: challengeDistance}
      }


      ///////////////////////
      var vvoRouteExample = [
        "Bus|5656331|4621971|5656332|4621947|5656338|4621858|5656342|4621761|5656364|4621653|5656395|4621577|5656411|4621553|5656411|4621553|5656418|4621543|5656432|4621520|5656443|4621504|5656453|4621488|5656467|4621469|5656558|4621329|5656561|4621317|5656581|4621287|5656599|4621263|5656606|4621253|5656613|4621243|5656634|4621214|5656647|4621196|",
        "Footpath|5656647|4621196|",
        "Tram|5656647|4621195|5656634|4621214|5656624|4621231|5656617|4621247|5656616|4621256|5656618|4621265|5656624|4621283|5656685|4621390|5656701|4621415|5656726|4621442|5656748|4621458|5656763|4621468|5656782|4621478|5656900|4621517|5656979|4621539|5656979|4621539|5657040|4621555|5657079|4621567|5657237|4621609|5657382|4621647|5657402|4621649|5657416|4621649|5657428|4621650|5657434|4621652|5657484|4621677|5657484|4621677|5657497|4621684|5657555|4621712|5657573|4621722|5657589|4621732|5657611|4621746|5657639|4621759|5657693|4621793|5657693|4621793|5657702|4621797|5657732|4621815|5657799|4621853|5657891|4621917|5657933|4621948|5657982|4621984|5657982|4621984|5658021|4622014|5658176|4622138|5658240|4622191|5658279|4622223|5658347|4622282|5658358|4622291|5658377|4622301|5658414|4622319|5658477|4622350|5658552|4622386|5658552|4622386|5658575|4622398|5658588|4622406|5658596|4622410|5658608|4622421|5658622|4622431|5658628|4622440|5658630|4622440|5658639|4622450|5658661|4622474|5658683|4622494|5658693|4622501|5658702|4622508|5658766|4622541|5658816|4622567|5658852|4622582|5658870|4622587|5658889|4622591|5658902|4622595|5658938|4622601|5658957|4622606|5658957|4622606|5658967|4622608|5658991|4622612|5659010|4622614|5659022|4622614|5659036|4622614|5659059|4622612|5659092|4622606|5659389|4622527|5659436|4622516|5659442|4622513|5659473|4622505|5659512|4622508|5659521|4622508|5659557|4622511|5659556|4622511|5659574|4622512|5659579|4622513|5659596|4622513|5659625|4622511|5659727|4622504|5659732|4622503|5659776|4622500|5659875|4622493|5659969|4622486|5659991|4622485|5659999|4622485|5660006|4622485|5660011|4622486|5660019|4622487|5660024|4622487|5660027|4622488|5660032|4622488|5660034|4622489|5660040|4622490|5660046|4622492|5660054|4622494|5660064|4622499|5660123|4622535|5660123|4622533|5660135|4622541|5660149|4622549|5660168|4622552|5660189|4622552|5660242|4622554|5660287|4622554|5660445|4622558|5660503|4622560|5660616|4622585|5660627|4622589|5660627|4622589|5660666|4622606|5660738|4622641|5660773|4622657|5660863|4622705|5661010|4622784|",
        "Footpath|5661010|4622784|5661005|4622785|5661004|4622785|5661006|4622786|5661005|4622787|5661003|4622791|5661005|4622792|5661021|4622800|5661022|4622802|5661026|4622804|5661029|4622799|5661030|4622798|5661030|4622797|5661034|4622790|5661038|4622789|5661040|4622787|5661042|4622785|5661046|4622768|5661050|4622753|5661056|4622757|5661057|4622758|5661058|4622762|",
        "Tram|5661056|4622761|5661052|4622782|5661046|4622808|5660993|4622920|5660913|4623103|5660886|4623164|"
      ]

      var firstProjection = "+proj=tmerc +lat_0=0 +lon_0=12 +k=1 +x_0=4500000 +y_0=0 +ellps=bessel +towgs84=598.1,73.7,418.2,0.202,0.045,-2.455,6.7 +units=m +no_defs";
      var secondProjection = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
      
      var vvoRouteGeoJSON = {
        type: "FeatureCollection",
        features: []
      };

      vvoRouteExample.forEach(element => {
        var vvoRouteFeature = {
          type: "Feature",
          geometry: {
            type: "LineString",
            coordinates: [],
          },
          properties: {
            routeType: null
          }
        };
        let routeStep = element.split('|');
        if (routeStep.length > 3) {
          
        
        vvoRouteFeature.properties.routeType = routeStep[0];

        coordinates = []
        for (let i = 1; i < routeStep.length - 1; i = i+2) {
          const element = [parseInt(routeStep[i+1], 10), parseInt(routeStep[i], 10)];
          
          coordinates.push(proj4(firstProjection, secondProjection, element));
        }
        vvoRouteFeature.geometry.coordinates = coordinates;

        vvoRouteGeoJSON.features.push(vvoRouteFeature);
      }
        
      });
      console.log(vvoRouteGeoJSON)


      ///////////////////////

      var handleGeoJsonLayers = function (dataList) {
        var overlayMaps = {};
        for (var j = 0; j < dataList.length; j++) {
          var entry = dataList[j]
          overlayMaps[layerLegendKey(entry.name)] = entry.geoJsonLayer;
        }

        var baseMaps = {};
        L.control.layers(baseMaps, overlayMaps).addTo(karte);
        names.forEach(name => overlayMaps[layerLegendKey(name)].addTo(karte));
      };
      var promises = [];
      for (var i = 0; i < names.length; i++) {
        var name = names[i]
        var color = colors[i];
        var lineStrokeWeight = lineStrokeWeights[i];
        var path = `data/example/${name}.geojson`;
        var promise = Promise.all([$.getJSON(path), Promise.resolve(color),
        Promise.resolve(lineStrokeWeight), Promise.resolve(name)])
        promises.push(promise.then(data => {
          return {
            geoJsonLayer: createGeoJsonLayer(data[0], data[1], data[2]),
            name: data[3]
          }
        }));
      }
      Promise.all(promises).then(dataList => handleGeoJsonLayers(dataList));

      $('.selector').click(function () {
        $('.dropDown').slideToggle(300);
      });

      {
        $.getJSON("data/DVB-bus_stops.geojson", function (data) {
          var geojsonEbene = L.geoJson(data);
          karte.addLayer(geojsonEbene);
        });
      }
      var redIcon = new L.Icon({
        // Quelle der Icons: https://github.com/pointhi/leaflet-color-markers
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [0, 0],
        shadowSize: [41, 41]
      });
      {
        var teilAutoIcon = new L.Icon({
          iconUrl: 'data/icons/teilauto.png',
          iconSize: [30, 30],
          iconAnchor: [12, 41],
          popupAnchor: [0, 0],
          shadowSize: [30, 30]
        });
        $.getJSON("data/Carsharing_Station.geojson", function (data) {
          var carCharingEbene = L.geoJson(data, {
            pointToLayer: function (feature, latlng) {
              var newCoords = feature.geometry.coordinates
              var dist = turf.pointToLineDistance(new turf.point(newCoords), new turf.lineString(collectedFeatureLineItems), { units: 'kilometers' })
              if (dist < 0.5) {
                return L.marker(latlng, { icon: teilAutoIcon });
              } else {
                return null
              }
            }
          });
          karte.addLayer(carCharingEbene);
        });
      }
      {

        var busIcon = new L.Icon({
          iconUrl: 'data/icons/bus_pin.png',
          iconSize: [20, 20],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0],
          shadowSize: [12, 12]
        });
        $.getJSON("data/VVO-bus_stops.geojson", function (data) {
          var busEbene = L.geoJson(data, {
            pointToLayer: function (feature, latlng) {
              var newCoords = feature.geometry.coordinates
              var dist = turf.pointToLineDistance(new turf.point(newCoords), new turf.lineString(collectedFeatureLineItems), { units: 'kilometers' })
              if (dist < 0.5) {
                return L.marker(latlng, { icon: busIcon });
              } else {
                return null
              }
            }
          });
          karte.addLayer(busEbene);
        });
      }
      {
        var tramIcon = new L.Icon({
          iconUrl: 'data/icons/Tram-Logo.png',
          iconSize: [20, 20],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0],
          shadowSize: [12, 12]
        });
        $.getJSON("data/DVB-tram_stops.geojson", function (data) {
          var tramEbene = L.geoJson(data, {
            pointToLayer: function (feature, latlng) {
              var newCoords = feature.geometry.coordinates
              var dist = turf.pointToLineDistance(new turf.point(newCoords), new turf.lineString(collectedFeatureLineItems), { units: 'kilometers' })
              if (dist < 0.5) {
                return L.marker(latlng, { icon: tramIcon });
              } else {
                return null
              }
            }
          });
          karte.addLayer(tramEbene);
        });
      }
      {
        var mobiIcon = new L.Icon({
          iconUrl: 'data/icons/News_332px_249px_MOBI.png',
          iconSize: [30, 30],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0],
          shadowSize: [30, 30]
        });
        $.getJSON("data/Mobipunkte-aktiv.geojson", function (data) {
          var mobiEbene = L.geoJson(data, {
            pointToLayer: function (feature, latlng) {
              var newCoords = feature.geometry.coordinates
              var dist = turf.pointToLineDistance(new turf.point(newCoords), new turf.lineString(collectedFeatureLineItems), { units: 'kilometers' })
              if (dist < 0.5) {
                return L.marker(latlng, { icon: mobiIcon });
              } else {
                return null
              }
            }
          });
          karte.addLayer(mobiEbene);
        });
      }
      {
        var monuIcon = new L.Icon({
          iconUrl: 'data/icons/sightseeing.png',
          iconSize: [20, 20],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0],
          shadowSize: [30, 30]
        });
        $.getJSON("data/Sehenswuerdigkeiten.geojson", function (data) {
          var monuEbene = L.geoJson(data, {
            pointToLayer: function (feature, latlng) {
              var newCoords = feature.geometry.coordinates
              var dist = turf.pointToLineDistance(new turf.point(newCoords), new turf.lineString(collectedFeatureLineItems), { units: 'kilometers' })
              if (dist < 0.5) {
                return L.marker(latlng, { icon: monuIcon });
              } else {
                return null
              }
            }
          });
          karte.addLayer(monuEbene);
        });
      }
      {
        var parkIcon = new L.Icon({
          iconUrl: 'data/icons/park_pin.png',
          iconSize: [20, 20],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0],
          shadowSize: [14, 14]
        });
        $.getJSON("data/park.geojson", function (data) {
          var parkEbene = L.geoJson(data, {
            pointToLayer: function (feature, latlng) {
              var newCoords = feature.geometry.coordinates
              var dist = turf.pointToLineDistance(new turf.point(newCoords), new turf.lineString(collectedFeatureLineItems), { units: 'kilometers' })
              if (dist < 0.5) {
                return L.marker(latlng, { icon: parkIcon });
              } else {
                return null
              }
            }
          });
          karte.addLayer(parkEbene);
        });
      }
      {
        var forestIcon = new L.Icon({
          iconUrl: 'data/icons/forest.png',
          iconSize: [30, 30],
          iconAnchor: [0, 0],
          popupAnchor: [0, 0],
          shadowSize: [30, 30]
        });
        function forestLines(feature, color) {
          return {
            color: '#33a02c',
            weight: 2,
            opacity: .9,
            lineJoin: 'round'
          };
        }
          $.getJSON("data/waldflaechen.geojson", function (data) {
          var forestEbene = L.geoJson(data, {
            style: forestLines
          });
          karte.addLayer(forestEbene);
        });
      }
      function riverLines(feature, color) {
        return {
          color: '#1f78b4',
          weight: 2,
          opacity: .9,
          lineJoin: 'round'
        };
      }
      $.getJSON("data/Elbe.geojson", function (data) {
        var riverEbene = L.geoJson(data, {
          style: riverLines
        });
        karte.addLayer(riverEbene);
      });

    </script>
</body>

</html>