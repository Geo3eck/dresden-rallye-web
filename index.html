<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Dresden Rallye: Challenge your daily route</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/css/bootstrap-datetimepicker.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
    integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
    crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.7.14/js/bootstrap-datetimepicker.min.js"></script>
  <style>
    #KarteMitPunkt {
      height: 480px;
    }

    .info {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }

    .info h4 {
      margin: 0 0 5px;
      color: #777;
    }

    .legend {
      text-align: left;
      line-height: 18px;
      color: #555;
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
  <style>
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class='col-sm-12' id="KarteMitPunkt" />
    </div>
  </div>
  <script>
    // Karte mit Mittelpunkt Dresden erzeugen
    var laengenGrad = 13.7381437;
    var breitenGrad = 51.0493286;
    var kartenMittelpunktKoordinaten = [breitenGrad, laengenGrad];
    var zoomStufe = 14;
    var minDate = moment();
    var maxDate = moment();
    maxDate.add('1', 'hour');

    var karte = L.map('KarteMitPunkt').setView(kartenMittelpunktKoordinaten, zoomStufe);
    // Hintergrundkarte setzen
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(karte);

    var geoJsonDaten = {
      "type": "FeatureCollection",
      "features": [
      ]
    };

    var optionen = {
      filter: function (feature, layer) {
        return moment(feature.properties.coordTimes).isBetween(minDate, maxDate);
      }
    }
    // Punkt-Marker setzen
    var geojsonEbene = L.geoJson(geoJsonDaten, optionen);
    var schichtenGruppe = L.layerGroup([]);
    schichtenGruppe.addLayer(geojsonEbene);
    schichtenGruppe.addTo(karte);

    var hoverZuMarkerAbstand = function (aktuelleZoomStufe) {
      return 0.39 / Math.pow(2, aktuelleZoomStufe - 6);
    };
    var geojsonEbenenHover;
    geojsonEbene.on('mouseover', function (ereignis) {
      var koordinaten = ereignis.layer.feature.geometry.coordinates;
      var hoverKoordinaten = [koordinaten[1] + hoverZuMarkerAbstand(karte.getZoom()), koordinaten[0]];
      if (karte) {
        var eigenschaften = ereignis.layer.feature.properties
        geojsonEbenenHover = L.popup()
          .setLatLng(hoverKoordinaten)
          .setContent(eigenschaften.name2)
          .openOn(karte);
      }
    });
    geojsonEbene.on('mouseout', function (ereignis) {
      if (geojsonEbenenHover && karte) {
        karte.closePopup(geojsonEbenenHover);
        geojsonEbenenHover = null;
      }
    });

    var schichtNeuLaden = function () {
      schichtenGruppe.clearLayers();
      karte.removeLayer(schichtenGruppe);
      var geojsonEbene = L.geoJson(geoJsonDaten, optionen);
      schichtenGruppe.addLayer(geojsonEbene);
      schichtenGruppe.addTo(karte);
    };

    var info = L.control();

    info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info');
      this.update();
      return this._div;
    };

    info.update = function (id, props) {
      var ref = this;
      $.ajax({
        url: "https://geo3eck.github.io/dresden-rallye-web/html/forms.html", success: function (htmlInner) {
          ref._div.innerHTML = htmlInner;
        }, error: function (err) {
          ref._div.innerHTML = 'Could not load form'
        }
      });
    };

    info.addTo(karte);

    function availableStations() {
      $.post("https://webapi.vvo-online.de/tr/pointfinder", {
        "query": "Albert",
        "limit": 10,
        "stopOnly": false
      }, function (data) {
        if (data.Status.Code == 'Ok') {
          var points = data.Points;
          var names = points.map(point => point.split('|')[3])
          return names;
        } else {
          return "Fehler in der API";
        }
      });
    }

    $(function () {
      $('#startauswahl').autocomplete({
        source: availableStations(),
        minLength: 3
      });
      $('#startdatumsauswahl').datetimepicker({
        defaultDate: minDate,
      });
      $('#enddatumsauswahl').datetimepicker({
        defaultDate: maxDate,
        useCurrent: false
      });
      $("#startdatumsauswahl").on("dp.change", function (e) {
        minDate = moment(e.date)
        $('#enddatumsauswahl').data("DateTimePicker").minDate(e.date);
        schichtNeuLaden();
      });
      $("#enddatumsauswahl").on("dp.change", function (e) {
        maxDate = moment(e.date)
        $('#startdatumsauswahl').data("DateTimePicker").maxDate(e.date);
        schichtNeuLaden();
      });
    });
  </script>
</body>

</html>